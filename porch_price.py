#!/usr/bin/env python3
import requests
import re
import json
import time
import datetime
import mongoengine
import credentials
from models import CostLink, ZipCode, Price
from data import machine_name
import sys
import threading
from mongoengine import DynamicDocument, StringField, IntField, BooleanField, ReferenceField, DateTimeField, FloatField

class PriceStatus(DynamicDocument):
    meta = {
        'collection': 'PriceStatus',
    }
    url_slug = StringField(db_field='url_slug', null=True)
    zipcode = StringField(db_field='zip', null=True)
    machine = StringField(db_field='machine', null=True)


def get_price_content(session, url_slug, apply_zip_codes, csrf_token):
    try:
        headers = {
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:83.0) Gecko/20100101 Firefox/83.0',
            'Accept': '*/*',
            'Accept-Language': 'en-US,en;q=0.5',
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Origin': 'https://porch.com',
            'Connection': 'keep-alive',
            'Referer': 'https://porch.com/project-cost/' + url_slug,
            'TE': 'Trailers',
        }

        i = 0
        for code in apply_zip_codes:
            i = i + 1
            data = {
                "requests": {
                    "g0": {
                        "resource": "costCalculator",
                        "operation": "read",
                        "params": {
                            "includeCompanies": True,
                            "includeDetails": True,
                            "skipLoad": False,
                            "calculatorType": "" + url_slug,
                            "postalCode": code,
                            "unitTotal": 1,
                            "userInput": True
                        }
                    }
                }, "context": {
                    "lang": "en-US",
                    "_csrf": csrf_token
                }
            }

            response = session.post(
                'https://porch.com/api-frontend-cost-calculator/?_csrf={}&lang=en-US'.format(csrf_token),
                headers=headers,
                data=json.dumps(data),
                # proxies=proxies
            )
            print(i, code)
            item = json.loads(response.text)
            item_data = item['g0']['data']
            del item_data['similarCalculatorsDTO']
            del item_data['relatedAdvice']
            del item_data['topPopularCalculatorsDTO']
            del item_data['topRelatedServicesCalculatorsDTO']
            del item_data['topSameServiceCalculatorsDTO']
            del item_data['relatedProjectDTO']
            del item_data['selectedProDTOs']
            del item_data['calculatorFaqDTOs']
            content = json.dumps(item_data)
            Price.objects(zipcode=int(code), url_slug=url_slug).update_one(set__content=content, set__blank=False, upsert=True)
            PriceStatus.objects(machine=machine_name).update_one(set__zipcode=code, set__url_slug=url_slug, upsert=True)
            time.sleep(0.5)
    except Exception as ex:
        print("*********Error*************")
        print(ex)
        pass

def start_scrape(url_slug):
    try:
        price_status = PriceStatus.objects.filter(machine=machine_name).first()
        zipcodes = ["00601", "00602", "00603", "00606", "00610", "00612", "00616", "00617", "00622", "00623", "00624", "00627", "00631", "00637", "00638", "00641", "00646", "00647", "00650", "00652", "00653", "00656", "00659", "00660", "00662", "00664", "00667", "00669", "00670", "00674", "00676", "00677", "00678", "00680", "00682", "00683", "00685", "00687", "00688", "00690", "00692", "00693", "00694", "00698", "00703", "00704", "00705", "00707", "00714", "00715", "00716", "00717", "00718", "00719", "00720", "00723", "00725", "00727", "00728", "00729", "00730", "00731", "00735", "00736", "00738", "00739", "00740", "00741", "00745", "00751", "00754", "00757", "00765", "00766", "00767", "00769", "00771", "00772", "00773", "00775", "00777", "00778", "00780", "00782", "00783", "00784", "00786", "00791", "00794", "00795", "00901", "00906", "00907", "00909", "00911", "00912", "00913", "00915", "00917", "00918", "00920", "00921", "00923", "00924", "00925", "00926", "00927", "00934", "00936", "00949", "00950", "00951", "00952", "00953", "00956", "00957", "00959", "00960", "00961", "00962", "00965", "00966", "00968", "00969", "00971", "00976", "00979", "00982", "00983", "00985", "00987", "01001", "01002", "01003", "01005", "01007", "01008", "01009", "01010", "01011", "01012", "01013", "01020", "01022", "01026", "01027", "01028", "01029", "01030", "01031", "01032", "01033", "01034", "01035", "01036", "01037", "01038", "01039", "01040", "01050", "01053", "01054", "01056", "01057", "01060", "01062", "01063", "01066", "01068", "01069", "01070", "01071", "01072", "01073", "01074", "01075", "01077", "01079", "01080", "01081", "01082", "01083", "01084", "01085", "01086", "01088", "01089", "01092", "01093", "01094", "01095", "01096", "01097", "01098", "01103", "01104", "01105", "01106", "01107", "01108", "01109", "01118", "01119", "01128", "01129", "01151", "01199", "01201", "01220", "01222", "01223", "01224", "01225", "01226", "01229", "01230", "01235", "01236", "01237", "01238", "01240", "01242", "01243", "01244", "01245", "01247", "01253", "01254", "01255", "01256", "01257", "01258", "01259", "01260", "01262", "01264", "01266", "01267", "01270", "01301", "01330", "01331", "01337", "01338", "01339", "01340", "01341", "01342", "01343", "01344", "01346", "01347", "01349", "01350", "01351", "01354", "01355", "01360", "01364", "01366", "01367", "01368", "01370", "01373", "01375", "01376", "01378", "01379", "01420", "01430", "01431", "01432", "01434", "01436", "01438", "01440", "01450", "01451", "01452", "01453", "01460", "01462", "01463", "01464", "01467", "01468", "01469", "01473", "01474", "01475", "01501", "01503", "01504", "01505", "01506", "01507", "01510", "01515", "01516", "01518", "01519", "01520", "01521", "01522", "01523", "01524", "01525", "01527", "01529", "01531", "01532", "01534", "01535", "01536", "01537", "01540", "01541", "01542", "01543", "01545", "01550", "01560", "01561", "01562", "01564", "01566", "01568", "01569", "01570", "01571", "01581", "01583", "01585", "01588", "01590", "01602", "01603", "01604", "01605", "01606", "01607", "01608", "01609", "01610", "01611", "01612", "01701", "01702", "01718", "01719", "01720", "01721", "01730", "01731", "01740", "01741", "01742", "01745", "01746", "01747", "01748", "01749", "01752", "01754", "01756", "01757", "01760", "01770", "01772", "01773", "01775", "01776", "01778", "01801", "01803", "01810", "01821", "01824", "01826", "01827", "01830", "01832", "01833", "01834", "01835", "01840", "01841", "01843", "01844", "01845", "01850", "01851", "01852", "01854", "01860", "01862", "01863", "01864", "01867", "01876", "01879", "01880", "01886", "01887", "01890", "01901", "01902", "01904", "01905", "01906", "01907", "01908", "01913", "01915", "01921", "01922", "01923", "01929", "01930", "01937", "01938", "01940", "01944", "01945", "01949", "01950", "01951", "01952", "01960", "01966", "01969", "01970", "01982", "01983", "01984", "01985", "02019", "02021", "02025", "02026", "02030", "02032", "02035", "02038", "02043", "02045", "02047", "02048", "02050", "02052", "02053", "02054", "02056", "02061", "02062", "02066", "02067", "02071", "02072", "02081", "02090", "02093", "02108", "02109", "02110", "02111", "02113", "02114", "02115", "02116", "02118", "02119", "02120", "02121", "02122", "02124", "02125", "02126", "02127", "02128", "02129", "02130", "02131", "02132", "02134", "02135", "02136", "02138", "02139", "02140", "02141", "02142", "02143", "02144", "02145", "02148", "02149", "02150", "02151", "02152", "02155", "02163", "02169", "02170", "02171", "02176", "02180", "02184", "02186", "02188", "02189", "02190", "02191", "02199", "02203", "02210", "02215", "02301", "02302", "02322", "02324", "02330", "02332", "02333", "02338", "02339", "02341", "02343", "02346", "02347", "02351", "02356", "02357", "02359", "02360", "02364", "02366", "02367", "02368", "02370", "02375", "02379", "02382", "02420", "02421", "02445", "02446", "02451", "02452", "02453", "02457", "02458", "02459", "02460", "02461", "02462", "02464", "02465", "02466", "02467", "02468", "02472", "02474", "02476", "02478", "02481", "02482", "02492", "02493", "02494", "02532", "02534", "02535", "02536", "02537", "02538", "02539", "02540", "02542", "02543", "02553", "02554", "02556", "02557", "02558", "02559", "02561", "02562", "02563", "02564", "02568", "02571", "02575", "02576", "02584", "02601", "02630", "02631", "02632", "02633", "02635", "02637", "02638", "02639", "02641", "02642", "02643", "02644", "02645", "02646", "02647", "02648", "02649", "02650", "02651", "02652", "02653", "02655", "02657", "02659", "02660", "02663", "02664", "02666", "02667", "02668", "02669", "02670", "02671", "02672", "02673", "02675", "02702", "02703", "02713", "02715", "02717", "02718", "02719", "02720", "02721", "02723", "02724", "02725", "02726", "02738", "02739", "02740", "02743", "02744", "02745", "02746", "02747", "02748", "02760", "02762", "02763", "02764", "02766", "02767", "02769", "02770", "02771", "02777", "02779", "02780", "02790", "02791", "02802", "02804", "02806", "02807", "02808", "02809", "02812", "02813", "02814", "02815", "02816", "02817", "02818", "02822", "02825", "02826", "02827", "02828", "02830", "02831", "02832", "02833", "02835", "02836", "02837", "02838", "02839", "02840", "02841", "02842", "02852", "02857", "02858", "02859", "02860", "02861", "02863", "02864", "02865", "02871", "02872", "02873", "02874", "02875", "02876", "02878", "02879", "02881", "02882", "02885", "02886", "02888", "02889", "02891", "02892", "02893", "02894", "02895", "02896", "02898", "02903", "02904", "02905", "02906", "02907", "02908", "02909", "02910", "02911", "02912", "02914", "02915", "02916", "02917", "02919", "02920", "02921", "03031", "03032", "03033", "03034", "03036", "03037", "03038", "03042", "03043", "03044", "03045", "03046", "03047", "03048", "03049", "03051", "03052", "03053", "03054", "03055", "03057", "03060", "03062", "03063", "03064", "03070", "03071", "03076", "03077", "03079", "03082", "03084", "03086", "03087", "03101", "03102", "03103", "03104", "03106", "03109", "03110", "03215", "03216", "03217", "03218", "03220", "03221", "03222", "03223", "03224", "03225", "03226", "03227", "03229", "03230", "03231", "03233", "03234", "03235", "03237", "03238", "03240", "03241", "03242", "03243", "03244", "03245", "03246", "03249", "03251", "03253", "03254", "03255", "03256", "03257", "03258", "03259", "03260", "03261", "03262", "03263", "03264", "03266", "03268", "03269", "03273", "03275", "03276", "03278", "03279", "03280", "03281", "03282", "03284", "03285", "03287", "03290", "03291", "03293", "03301", "03303", "03304", "03307", "03431", "03440", "03441", "03442", "03443", "03444", "03445", "03446", "03447", "03448", "03449", "03450", "03451", "03452", "03455", "03456", "03457", "03458", "03461", "03462", "03464", "03465", "03466", "03467", "03470", "03561", "03570", "03574", "03575", "03576", "03579", "03580", "03581", "03582", "03583", "03584", "03585", "03586", "03588", "03590", "03592", "03593", "03595", "03597", "03598", "03601", "03602", "03603", "03604", "03605", "03607", "03608", "03609", "03740", "03741", "03743", "03745", "03746", "03748", "03750", "03751", "03752", "03753", "03754", "03755", "03765", "03766", "03768", "03770", "03771", "03773", "03774", "03777", "03779", "03780", "03781", "03782", "03784", "03785", "03801", "03809", "03810", "03811", "03812", "03813", "03814", "03816", "03817", "03818", "03819", "03820", "03823", "03824", "03825", "03826", "03827", "03830", "03832", "03833", "03835", "03836", "03837", "03838", "03839", "03840", "03841", "03842", "03844", "03845", "03846", "03847", "03848", "03849", "03850", "03851", "03852", "03853", "03854", "03855", "03856", "03857", "03858", "03860", "03861", "03862", "03864", "03865", "03867", "03868", "03869", "03870", "03871", "03872", "03873", "03874", "03875", "03878", "03882", "03883", "03884", "03885", "03886", "03887", "03890", "03894", "03901", "03902", "03903", "03904", "03905", "03906", "03907", "03908", "03909", "03910", "03911", "04001", "04002", "04003", "04005", "04006", "04008", "04009", "04010", "04011", "04015", "04017", "04019", "04020", "04021", "04022", "04024", "04027", "04029", "04030", "04032", "04037", "04038", "04039", "04040", "04041", "04042", "04043", "04046", "04047", "04048", "04049", "04050", "04051", "04055", "04056", "04057", "04061", "04062", "04063", "04064", "04066", "04068", "04069", "04071", "04072", "04073", "04074", "04076", "04079", "04083", "04084", "04085", "04086", "04087", "04088", "04090", "04091", "04092", "04093", "04095", "04096", "04097", "04101", "04102", "04103", "04105", "04106", "04107", "04108", "04109", "04110", "04210", "04216", "04217", "04219", "04220", "04221", "04222", "04224", "04226", "04227", "04228", "04231", "04234", "04236", "04237", "04238", "04239", "04240", "04250", "04252", "04253", "04254", "04255", "04256", "04257", "04258", "04259", "04260", "04261", "04263", "04265", "04267", "04268", "04270", "04271", "04274", "04275", "04276", "04280", "04281", "04282", "04284", "04285", "04286", "04287", "04289", "04290", "04292", "04294", "04330", "04342", "04343", "04344", "04345", "04346", "04347", "04348", "04349", "04350", "04351", "04352", "04353", "04354", "04355", "04357", "04358", "04359", "04360", "04363", "04364", "04401", "04406", "04408", "04410", "04411", "04412", "04413", "04414", "04415", "04416", "04417", "04418", "04419", "04421", "04422", "04424", "04426", "04427", "04428", "04429", "04430", "04431", "04434", "04435", "04438", "04441", "04442", "04443", "04444", "04448", "04449", "04450", "04451", "04453", "04454", "04455", "04456", "04457", "04459", "04460", "04461", "04462", "04463", "04464", "04468", "04469", "04471", "04472", "04473", "04474", "04475", "04476", "04478", "04479", "04481", "04485", "04487", "04488", "04489", "04490", "04491", "04492", "04493", "04495", "04496", "04497", "04530", "04535", "04537", "04538", "04539", "04541", "04543", "04544", "04547", "04548", "04551", "04553", "04554", "04555", "04556", "04558", "04562", "04563", "04564", "04568", "04570", "04571", "04572", "04573", "04574", "04575", "04576", "04578", "04579", "04605", "04606", "04607", "04609", "04611", "04612", "04613", "04614", "04616", "04617", "04619", "04622", "04623", "04624", "04625", "04626", "04627", "04628", "04629", "04630", "04631", "04634", "04635", "04637", "04640", "04642", "04643", "04644", "04645", "04646", "04648", "04649", "04650", "04652", "04653", "04654", "04655", "04657", "04658", "04660", "04662", "04664", "04666", "04667", "04668", "04669", "04671", "04673", "04674", "04675", "04676", "04677", "04679", "04680", "04681", "04683", "04684", "04685", "04686", "04691", "04693", "04694", "04730", "04732", "04733", "04734", "04735", "04736", "04739", "04740", "04741", "04742", "04743", "04745", "04746", "04747", "04750", "04756", "04757", "04758", "04760", "04761", "04762", "04763", "04764", "04765", "04766", "04768", "04769", "04772", "04773", "04774", "04776", "04777", "04779", "04780", "04781", "04783", "04785", "04786", "04787", "04841", "04843", "04847", "04848", "04849", "04851", "04852", "04853", "04854", "04855", "04856", "04858", "04859", "04860", "04861", "04862", "04863", "04864", "04901", "04910", "04911", "04912", "04915", "04917", "04918", "04920", "04921", "04922", "04923", "04924", "04925", "04926", "04927", "04928", "04929", "04930", "04932", "04933", "04936", "04937", "04938", "04939", "04940", "04941", "04942", "04943", "04944", "04945", "04947", "04949", "04950", "04951", "04952", "04953", "04955", "04956", "04957", "04958", "04961", "04962", "04963", "04964", "04965", "04966", "04967", "04969", "04970", "04971", "04973", "04974", "04975", "04976", "04978", "04979", "04981", "04982", "04983", "04984", "04985", "04986", "04987", "04988", "04989", "04992", "05001", "05031", "05032", "05033", "05034", "05035", "05036", "05037", "05038", "05039", "05040", "05041", "05042", "05043", "05045", "05046", "05048", "05050", "05051", "05052", "05053", "05055", "05056", "05058", "05059", "05060", "05061", "05062", "05065", "05067", "05068", "05069", "05070", "05071", "05072", "05075", "05076", "05077", "05079", "05081", "05083", "05084", "05086", "05089", "05091", "05101", "05141", "05142", "05143", "05146", "05148", "05149", "05150", "05151", "05152", "05153", "05154", "05155", "05156", "05158", "05161", "05201", "05250", "05251", "05252", "05253", "05254", "05255", "05257", "05260", "05261", "05262", "05301", "05340", "05341", "05342", "05343", "05345", "05346", "05350", "05352", "05353", "05354", "05355", "05356", "05358", "05359", "05360", "05361", "05362", "05363", "05401", "05403", "05404", "05405", "05408", "05439", "05440", "05441", "05442", "05443", "05444", "05445", "05446", "05447", "05448", "05450", "05452", "05454", "05455", "05456", "05457", "05458", "05459", "05461", "05462", "05463", "05464", "05465", "05468", "05471", "05472", "05473", "05474", "05476", "05477", "05478", "05481", "05482", "05483", "05485", "05486", "05487", "05488", "05489", "05491", "05492", "05494", "05495", "05602", "05640", "05641", "05647", "05648", "05649", "05650", "05651", "05652", "05653", "05654", "05655", "05656", "05657", "05658", "05660", "05661", "05663", "05664", "05667", "05669", "05672", "05673", "05674", "05675", "05676", "05677", "05678", "05679", "05680", "05681", "05682", "05701", "05730", "05732", "05733", "05734", "05735", "05736", "05737", "05738", "05739", "05740", "05742", "05743", "05744", "05747", "05748", "05751", "05753", "05757", "05758", "05759", "05760", "05761", "05762", "05763", "05764", "05765", "05766", "05767", "05769", "05770", "05772", "05773", "05774", "05775", "05776", "05777", "05778", "05819", "05820", "05821", "05822", "05824", "05825", "05826", "05827", "05828", "05829", "05830", "05832", "05833", "05836", "05837", "05839", "05841", "05842", "05843", "05845", "05846", "05847", "05850", "05851", "05853", "05855", "05857", "05858", "05859", "05860", "05862", "05866", "05867", "05868", "05871", "05872", "05873", "05874", "05875", "05901", "05902", "05903", "05904", "05905", "05906", "05907", "06001", "06002", "06010", "06013", "06016", "06018", "06019", "06020", "06021", "06022", "06023", "06024", "06026", "06027", "06029", "06031", "06032", "06033", "06035", "06037", "06039", "06040", "06042", "06043", "06051", "06052", "06053", "06057", "06058", "06059", "06060", "06061", "06062", "06063", "06065", "06066", "06067", "06068", "06069", "06070", "06071", "06073", "06074", "06076", "06078", "06081", "06082", "06084", "06085", "06088", "06089", "06090", "06091", "06092", "06093", "06095", "06096", "06098", "06103", "06105", "06106", "06107", "06108", "06109", "06110", "06111", "06112", "06114", "06117", "06118", "06119", "06120", "06160", "06226", "06231", "06232", "06234", "06235", "06237", "06238", "06239", "06241", "06242", "06243", "06247", "06248", "06249", "06250", "06254", "06255", "06256", "06259", "06260", "06262", "06263", "06264", "06266", "06268", "06269", "06277", "06278", "06279", "06280", "06281", "06282", "06320", "06330", "06331", "06332", "06333", "06334", "06335", "06336", "06339", "06340", "06350", "06351", "06353", "06354", "06355", "06357", "06359", "06360", "06365", "06370", "06371", "06373", "06374", "06375", "06376", "06377", "06378", "06379", "06380", "06382", "06384", "06385", "06387", "06389", "06390", "06401", "06403", "06405", "06409", "06410", "06412", "06413", "06414", "06415", "06416", "06417", "06418", "06419", "06420", "06422", "06423", "06424", "06426", "06437", "06438", "06441", "06442", "06443", "06444", "06447", "06450", "06451", "06455", "06456", "06457", "06460", "06461", "06467", "06468", "06469", "06470", "06471", "06472", "06473", "06475", "06477", "06478", "06479", "06480", "06481", "06482", "06483", "06484", "06488", "06489", "06492", "06498", "06510", "06511", "06512", "06513", "06514", "06515", "06516", "06517", "06518", "06519", "06524", "06525", "06604", "06605", "06606", "06607", "06608", "06610", "06611", "06612", "06614", "06615", "06702", "06704", "06705", "06706", "06708", "06710", "06712", "06716", "06750", "06751", "06752", "06754", "06755", "06756", "06757", "06758", "06759", "06762", "06763", "06770", "06776", "06777", "06778", "06779", "06782", "06783", "06784", "06785", "06786", "06787", "06790", "06791", "06793", "06794", "06795", "06796", "06798", "06801", "06804", "06807", "06810", "06811", "06812", "06820", "06824", "06825", "06830", "06831", "06840", "06850", "06851", "06853", "06854", "06855", "06856", "06870", "06877", "06878", "06880", "06883", "06890", "06896", "06897", "06901", "06902", "06903", "06905", "06906", "06907", "07001", "07002", "07003", "07004", "07005", "07006", "07008", "07009", "07010", "07011", "07012", "07013", "07014", "07016", "07017", "07018", "07020", "07021", "07022", "07023", "07024", "07026", "07027", "07028", "07029", "07030", "07031", "07032", "07033", "07034", "07035", "07036", "07039", "07040", "07041", "07042", "07043", "07044", "07045", "07046", "07047", "07050", "07052", "07054", "07055", "07057", "07058", "07059", "07060", "07062", "07063", "07064", "07065", "07066", "07067", "07068", "07069", "07070", "07071", "07072", "07073", "07074", "07075", "07076", "07077", "07078", "07079", "07080", "07081", "07082", "07083", "07086", "07087", "07088", "07090", "07092", "07093", "07094", "07095", "07102", "07103", "07104", "07105", "07106", "07107", "07108", "07109", "07110", "07111", "07112", "07114", "07201", "07202", "07203", "07204", "07205", "07206", "07208", "07302", "07304", "07305", "07306", "07307", "07310", "07311", "07401", "07403", "07405", "07407", "07410", "07416", "07417", "07418", "07419", "07420", "07421", "07422", "07423", "07424", "07430", "07432", "07435", "07436", "07438", "07439", "07440", "07442", "07444", "07446", "07450", "07452", "07456", "07457", "07458", "07460", "07461", "07462", "07463", "07465", "07470", "07480", "07481", "07495", "07501", "07502", "07503", "07504", "07505", "07506", "07508", "07512", "07513", "07514", "07522", "07524", "07601", "07603", "07604", "07605", "07606", "07607", "07608", "07620", "07621", "07624", "07626", "07627", "07628", "07630", "07631", "07632", "07640", "07641", "07642", "07643", "07644", "07645", "07646", "07647", "07648", "07649", "07650", "07652", "07656", "07657", "07660", "07661", "07662", "07663", "07666", "07670", "07675", "07676", "07677", "07701", "07702", "07703", "07704", "07711", "07712", "07716", "07717", "07718", "07719", "07720", "07721", "07722", "07723", "07724", "07726", "07727", "07728", "07730", "07731", "07732", "07733", "07734", "07735", "07737", "07738", "07739", "07740", "07746", "07747", "07748", "07750", "07751", "07753", "07755", "07756", "07757", "07758", "07760", "07762", "07764", "07801", "07803", "07820", "07821", "07822", "07823", "07825", "07826", "07827", "07828", "07830", "07832", "07833", "07834", "07836", "07838", "07840", "07842", "07843", "07846", "07847", "07848", "07849", "07850", "07851", "07852", "07853", "07856", "07857", "07860", "07863", "07865", "07866", "07869", "07870", "07871", "07874", "07876", "07878", "07880", "07881", "07882", "07885", "07901", "07920", "07921", "07922", "07924", "07926", "07927", "07928", "07930", "07931", "07932", "07933", "07934", "07935", "07936", "07939", "07940", "07945", "07946", "07950", "07960", "07961", "07970", "07974", "07976", "07977", "07979", "07980", "07981", "08001", "08002", "08003", "08004", "08005", "08006", "08007", "08008", "08009", "08010", "08011", "08012", "08014", "08015", "08016", "08019", "08020", "08021", "08022", "08023", "08026", "08027", "08028", "08029", "08030", "08031", "08033", "08034", "08035", "08036", "08037", "08038", "08039", "08041", "08042", "08043", "08045", "08046", "08048", "08049", "08050", "08051", "08052", "08053", "08054", "08055", "08056", "08057", "08059", "08060", "08061", "08062", "08063", "08064", "08065", "08066", "08067", "08068", "08069", "08070", "08071", "08072", "08073", "08074", "08075", "08077", "08078", "08079", "08080", "08081", "08083", "08084", "08085", "08086", "08087", "08088", "08089", "08090", "08091", "08092", "08093", "08094", "08095", "08096", "08097", "08098", "08102", "08103", "08104", "08105", "08106", "08107", "08108", "08109", "08110", "08201", "08202", "08203", "08204", "08205", "08210", "08212", "08215", "08217", "08221", "08223", "08224", "08225", "08226", "08230", "08232", "08234", "08240", "08241", "08242", "08243", "08244", "08246", "08247", "08248", "08251", "08260", "08270", "08302", "08310", "08311", "08312", "08314", "08316", "08317", "08318", "08319", "08320", "08321", "08322", "08323", "08324", "08326", "08327", "08328", "08329", "08330", "08332", "08340", "08341", "08343", "08344", "08345", "08346", "08348", "08349", "08350", "08352", "08353", "08360", "08361", "08401", "08402", "08403", "08406", "08501", "08502", "08505", "08510", "08511", "08512", "08514", "08515", "08518", "08520", "08525", "08527", "08528", "08530", "08533", "08534", "08535", "08536", "08540", "08542", "08550", "08551", "08553", "08554", "08555", "08558", "08559", "08560", "08561", "08562", "08608", "08609", "08610", "08611", "08618", "08619", "08620", "08628", "08629", "08638", "08640", "08641", "08648", "08690", "08691", "08701", "08720", "08721", "08722", "08723", "08724", "08730", "08731", "08732", "08733", "08734", "08735", "08736", "08738", "08740", "08741", "08742", "08750", "08751", "08752", "08753", "08755", "08757", "08758", "08759", "08801", "08802", "08804", "08805", "08807", "08808", "08809", "08810", "08812", "08816", "08817", "08820", "08821", "08822", "08823", "08824", "08825", "08826", "08827", "08828", "08829", "08830", "08831", "08832", "08833", "08835", "08836", "08837", "08840", "08844", "08846", "08848", "08850", "08852", "08853", "08854", "08857", "08858", "08859", "08861", "08863", "08865", "08867", "08869", "08872", "08873", "08876", "08879", "08880", "08882", "08884", "08886", "08887", "08889", "08890", "08901", "08902", "08904"]
        elemIndex = 0
        elemCount = 1500
        if price_status is None or price_status.url_slug != url_slug:
            elemIndex = 0
        else:
            elemIndex = zipcodes.index(price_status.zipcode) + 1
        toIndex = len(zipcodes) if elemIndex + elemCount > len(zipcodes) else elemIndex + elemCount
        apply_zip_codes = zipcodes[elemIndex:toIndex]
        if len(apply_zip_codes) == 0:
            CostLink.objects(url_slug=url_slug).update_one(status='Done', upsert=True)
            return
        CostLink.objects(url_slug=url_slug).update_one(status='In-Progress', upsert=True)
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:83.0) Gecko/20100101 Firefox/83.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Referer': 'https://porch.com/project-cost',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Cache-Control': 'max-age=0',
            'TE': 'Trailers',
        }

        # proxies = {
        #     'http': 'http://195.25.19.4:3128',
        #     'https': 'http://195.25.19.4:3128'
        # }

        session = requests.Session()
        print("Waiting Response ...")
        response = session.get(
            'https://porch.com/project-cost/' + url_slug,
            headers=headers,
            # proxies=proxies
        )

        regex = re.search(
            r'"CsrfStore":\{"token":"(.*?)"\}',
            response.text,
            re.S | re.M | re.I
        )
        csrf_token = regex.group(1)

        headers = {
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:83.0) Gecko/20100101 Firefox/83.0',
            'Accept': '*/*',
            'Accept-Language': 'en-US,en;q=0.5',
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Origin': 'https://porch.com',
            'Connection': 'keep-alive',
            'Referer': 'https://porch.com/project-cost/' + url_slug,
            'TE': 'Trailers',
        }

        print("Token : ", csrf_token)
        
        # first_index = len(apply_zip_codes) // 3
        # second_index = first_index * 2
        
        # first_list = apply_zip_codes[:first_index]
        # second_list = apply_zip_codes[first_index:second_index]
        # third_list = apply_zip_codes[second_index:]
        
        for codes in [apply_zip_codes]:
            threads = list()
            print("Main    : create and start thread {}.".format(len(codes)))
            x = threading.Thread(target=get_price_content, args=(session, url_slug, codes, csrf_token))
            threads.append(x)
            time.sleep(1)
            x.start()

        for index, thread in enumerate(threads):
            print("Main    : before joining thread {}.".format(index))
            thread.join()
            print("Main    : thread {} done".format(index))
    except Exception as ex:
        print("*********Error*************")
        print(ex)
    
if __name__ == "__main__":  

    # TODO
    # 1. Connect Remote DB
    # 2. Supervisor to continue run

    # mongoengine.connect(
    #     db=credentials.DB_DATABASE, host=credentials.DB_HOST,
    #     username=credentials.DB_USER, password=credentials.DB_PASSWORD, port=credentials.DB_PORT)    
    mongoengine.connect(host=credentials.DB_URI)

    cost_link = CostLink.objects.filter(machine = machine_name, status__ne='Done').first()

    if cost_link:
        print("***********Start************")
        print(cost_link.url_slug, datetime.datetime.now())
        start_scrape(cost_link.url_slug)

        # time.sleep(30)
        print(cost_link.url_slug, datetime.datetime.now())
        print("*****************Done*******************")
